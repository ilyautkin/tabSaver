<div class="top-border"></div>
<div class="jumbotron">
	<h2>[[*pagetitle]]</h2>
	<p>[[*introtext]]</p>
	<div class="row" style="position: relative;">
		<div class="col-xs-10">
			<input type="url" name="url" id="url-input" placeholder="URL" class="form-control" value="[[!get? &need=`url`]]">
		</div>
		<div class="col-xs-2">
			<span class="btn btn-success form-control" id="save-btn">Сохранить</span>
		</div>
		<div id="progress-wrapper" class="jumbotron">
			<div class="progress"><div class="progress-bar" role="progressbar" id="adding-progress"></div></div>
		</div>
	</div>
</div>
<div class="list-group" id="pages-list">
    [[!pdoResources?
        &class=`tabSaverTab`
        &loadModels=`tabsaver`
        &select=`tabSaverTab.*`
        &sortby=`{"id":"DESC"}`
        &where=`{"uid":[[!+modx.user.id]],"deleted":0}`
        &tpl=`tpl.tabSaverTab`
    ]]
</div>
<script type="text/javascript">
	function animateProgress(elem, parent, width, delta){
		delta = delta / 1.1 || 5;
		width = width || 30;
		window.setTimeout(function(){
			elem.css({width: (width + delta) + '%'});
			console.log((width + delta) + '%');
			if (window.complite) {
				elem.css({width: '100%'});
				window.setTimeout(function(){
					parent.hide();
					elem.css({width: 0});
				}, 500);
			} else {
				animateProgress(elem, parent, width + delta, delta);
			}
		}, 500);

	}
	function saveUrl(url) {
		$('#progress-wrapper').show();
		$('#url-input').parent().removeClass('has-error');
		$('#url-input').attr('disabled','disabled');
		$('#save-btn').addClass('disabled');
		window.complite = false;
		animateProgress($('#adding-progress'), $('#progress-wrapper'));
		$.post(document.location.href.split('?')[0], {action: 'addurl', url: url}, function(data){
			$('#url-input').removeAttr('disabled');
			$('#save-btn').removeClass('disabled');
			//$('#new-item').replaceWith(data.html);
                        if (data.success) {
                            $('#url-input').val('');
                            $('#pages-list').prepend(data.html);
                        } else {
                            $('#url-input').parent().addClass('has-error');
                        }
			window.complite = true;
			window.success = data.success;
			$(document).trigger("as_complete");
		}, 'json');
	}
        function sendUrl() {
            if (!$('#save-btn').hasClass('disabled') && $('#url-input').val() != '') {
                    saveUrl($('#url-input').val());
            } else if($('#url-input').val() == '') {
                    $('#url-input').parent().addClass('has-error');
            }
        }
	if ($('#url-input').val() != '') {
		saveUrl($('#url-input').val());
	}
	$(document).on('click','#save-btn', sendUrl);
        document.onkeydown = function (event) {
            switch(event.keyCode) {
                case 10:
                case 13:
                    sendUrl();
                default: break;
            }
        }
	$(document).on("as_complete", function(){
            if (window.success) {
		$('#pages-list .list-group-item:first-child').css({height: "0px", opacity: 0});
		$('#pages-list .list-group-item:first-child').animate({height: "110px", opacity: 1}, 1000);
            }
	});
</script>